<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>JaKÃ²b - Notifications</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ea2a33",
                        "primary-dark": "#c91b24",
                        "background-light": "#f8f6f6",
                        "background-dark": "#211111",
                        "surface-dark": "#2f1a1b",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "sm": "0.5rem",
                        "md": "0.75rem",
                        "lg": "1.5rem",
                        "xl": "2rem",
                        "2xl": "2.5rem",
                        "3xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
        }
    </style>
</head>
<body class="bg-background-dark font-display antialiased selection:bg-primary selection:text-white">
    <!-- Main Container -->
    <div class="relative flex min-h-screen w-full max-w-md mx-auto flex-col bg-background-dark pb-24">
        <!-- Header -->
        <header class="sticky top-0 z-20 bg-background-dark/90 backdrop-blur-md border-b border-white/5">
            <div class="flex items-center justify-between p-4">
                <a href="profile.html" class="flex size-10 items-center justify-center rounded-full bg-white/5 text-white hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>
                </a>
                <h2 class="text-base font-bold tracking-wide text-white">Notifications</h2>
                <button class="flex size-10 items-center justify-center rounded-full bg-white/5 text-white hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined">done_all</span>
                </button>
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 px-4 pb-3 overflow-x-auto no-scrollbar">
                <button class="px-4 py-2 bg-primary text-white rounded-full text-xs font-bold whitespace-nowrap">
                    All
                </button>
                <button class="px-4 py-2 bg-white/5 text-white/70 hover:bg-white/10 rounded-full text-xs font-bold whitespace-nowrap">
                    Donations
                </button>
                <button class="px-4 py-2 bg-white/5 text-white/70 hover:bg-white/10 rounded-full text-xs font-bold whitespace-nowrap">
                    Updates
                </button>
                <button class="px-4 py-2 bg-white/5 text-white/70 hover:bg-white/10 rounded-full text-xs font-bold whitespace-nowrap">
                    System
                </button>
            </div>
        </header>

        <!-- Content -->
        <main id="notificationsContainer" class="relative z-10 flex-1 px-4 py-4 space-y-3">
            <!-- Loading State -->
            <div id="loadingState" class="flex items-center justify-center py-16">
                <div class="animate-spin size-12 border-4 border-primary border-t-transparent rounded-full"></div>
            </div>

            <!-- Empty State (shown when no notifications) -->
            <div id="emptyState" class="hidden flex-col items-center justify-center py-16 px-6">
                <div class="size-24 rounded-3xl bg-white/5 flex items-center justify-center mb-4">
                    <span class="material-symbols-outlined text-white/20 !text-6xl">notifications_off</span>
                </div>
                <h3 class="text-white font-bold text-lg mb-2">No Notifications</h3>
                <p class="text-white/50 text-sm text-center max-w-[240px]">
                    You're all caught up! We'll notify you when there's something new.
                </p>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[360px] bg-surface-dark/90 backdrop-blur-xl border border-white/10 rounded-full p-2 z-50 shadow-2xl flex justify-between items-center">
            <a class="flex flex-col items-center justify-center w-1/4 h-full gap-1 group" href="../main/home.html">
                <div class="p-2 rounded-full hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-white/50 group-hover:text-white text-2xl">home</span>
                </div>
            </a>
            <a class="flex flex-col items-center justify-center w-1/4 h-full gap-1 group" href="../main/explore.html">
                <div class="p-2 rounded-full hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-white/50 group-hover:text-white text-2xl">explore</span>
                </div>
            </a>
            <a class="flex flex-col items-center justify-center w-1/4 h-full gap-1 group" href="wallet.html">
                <div class="p-2 rounded-full hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-white/50 group-hover:text-white text-2xl">account_balance_wallet</span>
                </div>
            </a>
            <a class="flex flex-col items-center justify-center w-1/4 h-full gap-1 group" href="profile.html">
                <div class="p-2 rounded-full hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-white/50 group-hover:text-white text-2xl">person</span>
                </div>
            </a>
        </nav>
    </div>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <!-- User Data Loader -->
    <script src="/assets/js/user-data.js"></script>

    <script>
        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getNotificationColor(type) {
            const colors = {
                'donation': { border: 'border-primary', bg: 'bg-primary/20', text: 'text-primary', icon: 'favorite' },
                'campaign': { border: 'border-blue-500', bg: 'bg-blue-500/20', text: 'text-blue-400', icon: 'campaign' },
                'verification': { border: 'border-green-500', bg: 'bg-green-500/20', text: 'text-green-400', icon: 'verified' },
                'system': { border: 'border-purple-500', bg: 'bg-purple-500/20', text: 'text-purple-400', icon: 'notifications' },
                'milestone': { border: 'border-yellow-500', bg: 'bg-yellow-500/20', text: 'text-yellow-400', icon: 'stars' },
                'welcome': { border: 'border-pink-500', bg: 'bg-pink-500/20', text: 'text-pink-400', icon: 'celebration' }
            };
            return colors[type] || { border: 'border-white/10', bg: 'bg-white/10', text: 'text-white', icon: 'notifications' };
        }

        function renderNotification(notification) {
            const colors = getNotificationColor(notification.type);
            const isRead = notification.is_read == 1;
            const icon = notification.icon || colors.icon;

            const notifHTML = `
                <div class="relative ${isRead ? 'bg-surface-dark/50 border-l-4 border-white/10' : `bg-surface-dark border-l-4 ${colors.border}`} rounded-2xl p-4 hover:bg-surface-dark/80 transition-all">
                    <div class="flex gap-3">
                        <div class="size-12 rounded-xl ${colors.bg} flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined ${colors.text}">${icon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="${isRead ? 'text-white/80' : 'text-white'} font-bold text-sm mb-1">
                                ${escapeHtml(notification.title)}
                            </p>
                            <p class="${isRead ? 'text-white/60' : 'text-white/70'} text-xs leading-relaxed mb-2">
                                ${escapeHtml(notification.message)}
                            </p>
                            <div class="flex items-center gap-2">
                                <span class="text-white/40 text-xs">${getTimeAgo(notification.created_at)}</span>
                                ${!isRead ? `<span class="size-1.5 rounded-full ${colors.border.replace('border-', 'bg-')}"></span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return notifHTML;
        }

        function groupNotificationsByDate(notifications) {
            const groups = {
                today: [],
                yesterday: [],
                thisWeek: [],
                older: []
            };

            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(todayStart);
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
            const weekStart = new Date(todayStart);
            weekStart.setDate(weekStart.getDate() - 7);

            notifications.forEach(notif => {
                const notifDate = new Date(notif.created_at);

                if (notifDate >= todayStart) {
                    groups.today.push(notif);
                } else if (notifDate >= yesterdayStart) {
                    groups.yesterday.push(notif);
                } else if (notifDate >= weekStart) {
                    groups.thisWeek.push(notif);
                } else {
                    groups.older.push(notif);
                }
            });

            return groups;
        }

        async function loadNotifications() {
            try {
                const response = await fetch('/api/get-notifications.php?limit=50');
                const result = await response.json();

                const container = document.getElementById('notificationsContainer');
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');

                if (result.success && result.notifications && result.notifications.length > 0) {
                    const groups = groupNotificationsByDate(result.notifications);

                    let contentHTML = '';

                    if (groups.today.length > 0) {
                        contentHTML += `
                            <div class="space-y-3">
                                <h3 class="text-white/50 text-xs font-bold uppercase tracking-wider px-2">Today</h3>
                                ${groups.today.map(n => renderNotification(n)).join('')}
                            </div>
                        `;
                    }

                    if (groups.yesterday.length > 0) {
                        contentHTML += `
                            <div class="space-y-3 pt-4">
                                <h3 class="text-white/50 text-xs font-bold uppercase tracking-wider px-2">Yesterday</h3>
                                ${groups.yesterday.map(n => renderNotification(n)).join('')}
                            </div>
                        `;
                    }

                    if (groups.thisWeek.length > 0) {
                        contentHTML += `
                            <div class="space-y-3 pt-4">
                                <h3 class="text-white/50 text-xs font-bold uppercase tracking-wider px-2">This Week</h3>
                                ${groups.thisWeek.map(n => renderNotification(n)).join('')}
                            </div>
                        `;
                    }

                    if (groups.older.length > 0) {
                        contentHTML += `
                            <div class="space-y-3 pt-4">
                                <h3 class="text-white/50 text-xs font-bold uppercase tracking-wider px-2">Older</h3>
                                ${groups.older.map(n => renderNotification(n)).join('')}
                            </div>
                        `;
                    }

                    loadingState.classList.add('hidden');
                    container.innerHTML = contentHTML;
                } else {
                    loadingState.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    emptyState.classList.add('flex');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                const loadingState = document.getElementById('loadingState');
                loadingState.innerHTML = `
                    <div class="text-center py-16">
                        <p class="text-white/60 text-sm">Failed to load notifications</p>
                        <button onclick="loadNotifications()" class="mt-4 px-6 py-2 bg-primary hover:bg-primary-dark rounded-full text-white text-sm font-bold">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Load notifications on page load
        document.addEventListener('DOMContentLoaded', loadNotifications);
    </script>
</body>
</html>
